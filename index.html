<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ocorr√™ncias Atendidas ‚Äî Tema Cyberpunk (Neon Azul)</title>
  <!-- Parser robusto para CSV -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <style>
    /* ===== TEMA CYBERPUNK (NEON AZUL) ===== */
    * { margin:0; padding:0; box-sizing:border-box }
    :root {
      --bg1:#07051a; --bg2:#0f0b2d; --bg3:#14123b;
      --glass:rgba(6,12,40,.35); --glass-2:rgba(120,160,255,.18);
      --text:#eaf1ff; --muted:rgba(202,214,255,.78);
      --grad-a:#00e6ff;  /* ciano neon */
      --grad-b:#2f7bff;  /* azul el√©trico */
      --grad-c:#7c4dff;  /* violeta neon */
      --glow: 0 0 12px rgba(0,230,255,.55), 0 0 28px rgba(47,123,255,.35);
      --shadow:0 25px 50px rgba(0,0,0,.35);
    }

    body { font-family:'Inter','Segoe UI',system-ui,Arial,sans-serif; background:linear-gradient(135deg,var(--bg1) 0%,var(--bg2) 50%,var(--bg3) 100%); min-height:100vh; padding:20px; position:relative; color:var(--text) }
    body::before { content:""; position:fixed; inset:0; z-index:-1; pointer-events:none; background:
      radial-gradient(60rem 60rem at 20% 50%, rgba(0,230,255,.16) 0%, transparent 55%),
      radial-gradient(42rem 42rem at 80% 20%, rgba(124,77,255,.14) 0%, transparent 60%),
      radial-gradient(40rem 40rem at 40% 80%, rgba(47,123,255,.12) 0%, transparent 60%);
      filter:saturate(1.1);
    }

    .container { max-width:1200px; margin:0 auto; backdrop-filter: blur(20px); background:linear-gradient(180deg, rgba(18,25,61,.55), rgba(10,12,30,.45)); border:1px solid var(--glass-2); border-radius:24px; padding:32px; box-shadow:var(--shadow) }
    .header { text-align:center; margin-bottom:24px; position:relative }
    .header::before { content:""; position:absolute; top:-12px; left:50%; translate:-50% 0; width:180px; height:4px; border-radius:2px; background:linear-gradient(90deg,var(--grad-a),var(--grad-b),var(--grad-c)); box-shadow:var(--glow) }
    h1 { font-size:clamp(1.8rem,1.2rem + 2.2vw,3rem); font-weight:900; margin:8px 0 4px; letter-spacing:.4px; background:linear-gradient(135deg,var(--grad-a) 0%,var(--grad-b) 50%,var(--grad-c) 100%); -webkit-background-clip:text; background-clip:text; -webkit-text-fill-color:transparent; text-shadow:0 2px 18px rgba(0,230,255,.22)}
    .subtitle { color:var(--muted); font-weight:700; text-shadow:0 0 10px rgba(47,123,255,.25) }

    /* ===== Loading ===== */
    .upload { margin:16px 0 22px; border:2px dashed rgba(130,160,255,.35); border-radius:18px; padding:24px; text-align:center; background:rgba(10,15,45,.45); transition:.25s }
    .upload h3 { font-size:1.1rem; margin-bottom:6px }
    .upload p { color:var(--muted); font-size:.95rem; margin-bottom:12px }

    /* ===== Toolbar (centralizada) ===== */
    .toolbar { display:flex; gap:12px; flex-wrap:wrap; margin:12px 0 18px; justify-content:center; width:100%; }
    .tool { background:rgba(16,22,60,.6); border:1px solid rgba(120,160,255,.22); padding:10px 12px; border-radius:12px; display:flex; align-items:center; gap:8px; box-shadow:0 6px 18px rgba(0,0,0,.2) }
    .tool input[type=search] { background:transparent; border:none; outline:none; color:#e9f3ff; width:100%; }
    .toolbar .tool:first-child { flex: 1 1 clamp(280px, 60%, 720px); max-width: 720px; }
    .toolbar .tool:last-child { flex: 0 0 auto; padding:10px 14px; border-radius:999px; background:rgba(10,25,70,.55); border:1px solid rgba(120,170,255,.25); box-shadow:var(--glow) }
    .toolbar .tool:last-child small { font-weight:800; letter-spacing:.2px; color:var(--muted) }
    .ghost { opacity:.75 }

    /* ===== Cards ===== */
    .cards { display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:16px; margin-bottom:14px }
    .card { background:linear-gradient(135deg, rgba(0,230,255,.9), rgba(47,123,255,.9)); color:#fff; padding:20px; border-radius:18px; text-align:center; border:1px solid rgba(130,180,255,.3); box-shadow:var(--glow) }
    .card h3 { font-size:2rem; margin-bottom:4px; text-shadow:0 1px 12px rgba(0,230,255,.35) }

    /* ===== Pain√©is ===== */
    .panel { background:linear-gradient(180deg, rgba(14,18,48,.7), rgba(8,10,28,.6)); border:1px solid rgba(110,160,255,.22); border-radius:18px; overflow:hidden }
    .panel-hd { background:linear-gradient(135deg,var(--grad-a),var(--grad-b)); padding:14px 16px; font-weight:900; display:flex; align-items:center; gap:8px; box-shadow:var(--glow) }

    /* ===== Linhas ===== */
    .row { display:flex; justify-content:space-between; align-items:center; gap:16px; padding:16px; border-top:1px solid rgba(130,160,255,.16) }
    .row:first-child { border-top:none }
    .row:hover { background:rgba(10,25,70,.35) }
    .name { font-weight:900 }
    .muted { color:var(--muted); font-weight:700; font-size:.95rem }

    .stats { display:flex; gap:12px; flex-wrap:wrap }
    .pill { min-width:86px; text-align:center; padding:8px 10px; border-radius:10px; background:rgba(10,25,70,.55); border:1px solid rgba(120,170,255,.25); box-shadow:0 0 0 1px rgba(0,230,255,.05) inset }
    .pill b { font-size:1.2rem; color:var(--grad-a); text-shadow:0 0 10px rgba(0,230,255,.35) }

    .hidden { display:none }
    .footer { margin-top:14px; display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end }

    /* ===== Menu Lateral (Sidebar) ===== */
    .sidebar {
      position: fixed;
      top: 0;
      left: 0;
      width: 60px;
      height: 100vh;
      background: linear-gradient(180deg, var(--bg2) 0%, var(--bg3) 100%);
      padding: 20px 10px;
      box-shadow: 10px 0 20px rgba(0,0,0,.3);
      z-index: 10;
      overflow-y: auto;
      border-right: 1px solid var(--glass-2);
      transition: width .3s ease;
    }
    .sidebar.expanded {
      width: 250px;
    }
    .logo {
      text-align: center;
      margin-bottom: 30px;
    }
    .logo h2 {
      font-size: 1.5rem;
      font-weight: 900;
      background: linear-gradient(135deg, var(--grad-a) 0%, var(--grad-b) 50%, var(--grad-c) 100%);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      text-shadow: 0 2px 18px rgba(0,230,255,.22);
      opacity: 0;
      transition: opacity .3s ease;
    }
    .sidebar.expanded .logo h2 {
      opacity: 1;
    }
    .menu-list {
      list-style: none;
    }
    .menu-item {
      margin-bottom: 10px;
    }
    .menu-link {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 16px;
      border-radius: 12px;
      color: var(--text);
      text-decoration: none;
      font-weight: 700;
      transition: .25s;
      background: rgba(16,22,60,.6);
      border: 1px solid rgba(120,160,255,.22);
      box-shadow: 0 4px 12px rgba(0,0,0,.2);
    }
    .menu-link:hover, .menu-link.active {
      background: linear-gradient(135deg, var(--grad-a), var(--grad-b));
      box-shadow: var(--glow);
      color: #fff;
    }
    .menu-link:hover {
      translate: 0 -2px;
    }
    .menu-link span {
      opacity: 0;
      width: 0;
      overflow: hidden;
      transition: opacity .3s ease, width .3s ease;
    }
    .sidebar.expanded .menu-link span {
      opacity: 1;
      width: auto;
    }
    .main-content {
      margin-left: 60px;
      padding: 20px;
      transition: margin-left .3s ease;
    }
    .sidebar.expanded ~ .main-content {
      margin-left: 250px;
    }
    .menu-toggle {
      display: block;
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 11;
      background: var(--grad-b);
      border: none;
      color: #fff;
      padding: 10px;
      border-radius: 8px;
      cursor: pointer;
      box-shadow: var(--glow);
    }
    @media (max-width: 1024px) {
      .sidebar.expanded {
        width: 200px;
      }
      .sidebar.expanded ~ .main-content {
        margin-left: 200px;
      }
    }
    @media (max-width: 768px) {
      .sidebar {
        width: 60px;
        left: -60px;
        transition: left .3s ease;
      }
      .sidebar.expanded {
        left: 0;
        width: 100%;
      }
      .main-content {
        margin-left: 0;
      }
      .sidebar.expanded ~ .main-content {
        margin-left: 0;
      }
    }
  </style>
</head>
<body>
  <!-- Menu Lateral -->
  <nav class="sidebar">
    <div class="logo">
      <h2>Ocorr√™ncias</h2>
    </div>
    <ul class="menu-list">
      <li class="menu-item">
        <a href="#inicial" class="menu-link active" data-section="inicial">üè† <span>Inicial</span></a>
      </li>
      <li class="menu-item">
        <a href="#drogas" class="drogas-link" data-section="drogas">üíä <span>Drogas Apreendidas</span></a>
      </li>
      <li class="menu-item">
        <a href="#regioes" class="menu-link" data-section="regioes">üåç <span>Regi√µes</span></a>
      </li>
      <li class="menu-item">
        <a href="#horarios" class="menu-link" data-section="horarios">‚è∞ <span>Hor√°rios</span></a>
      </li>
      <li class="menu-item">
        <a href="#equipes" class="menu-link" data-section="equipes">üë• <span>Equipes</span></a>
      </li>
    </ul>
  </nav>

  <!-- Bot√£o para toggle menu -->
  <button class="menu-toggle" id="menuToggle">‚ò∞</button>

  <!-- Conte√∫do Principal -->
  <main class="main-content">
    <div class="container">
      <div class="header">
        <h1>Ocorr√™ncias Atendidas em <span id="yearText">2025</span></h1>
        <div class="subtitle">Sistema de an√°lise e monitoramento de ocorr√™ncias</div>
      </div>

      <div id="drop" class="upload" aria-label="√Årea de carregamento de dados">
        <h3>‚è≥ Carregando dados do CSV...</h3>
        <p>Os dados est√£o sendo obtidos diretamente do Google Sheets.</p>
        <div id="loading" class="ghost" style="margin-top:10px; font-weight:800">‚è≥ Processando dados‚Ä¶</div>
        <div id="parseWarn" class="ghost hidden" style="margin-top:8px"></div>
      </div>

      <div id="tools" class="toolbar hidden" role="region" aria-label="Ferramentas">
        <div class="tool">üîé <input id="q" type="search" placeholder="Buscar por categoria ou tipo‚Ä¶" aria-label="Buscar" /></div>
        <div class="tool"><small id="metaInfo">0 linhas</small></div>
      </div>

      <div id="cards" class="cards hidden"></div>

      <section id="cats" class="panel hidden" aria-live="polite">
        <div class="panel-hd">üìã Categorias</div>
        <div id="catList"></div>
      </section>

      <section id="types" class="panel hidden">
        <div class="panel-hd"><button id="back" class="btn" type="button">‚Üê Voltar</button> <span id="catTitle" style="font-weight:900"></span></div>
        <div id="typeList"></div>
      </section>

      <div class="footer hidden" id="totals"></div>

      <!-- Placeholders para as outras se√ß√µes -->
      <section id="drogas-section" class="panel hidden">
        <div class="panel-hd">üíä Drogas Apreendidas</div>
        <div>Conte√∫do a ser implementado...</div>
      </section>

      <section id="regioes-section" class="panel hidden">
        <div class="panel-hd">üåç Regi√µes</div>
        <div>Conte√∫do a ser implementado...</div>
      </section>

      <section id="horarios-section" class="panel hidden">
        <div class="panel-hd">‚è∞ Hor√°rios</div>
        <div>Conte√∫do a ser implementado...</div>
      </section>

      <section id="equipes-section" class="panel hidden">
        <div class="panel-hd">üë• Equipes</div>
        <div>Conte√∫do a ser implementado...</div>
      </section>
    </div>
  </main>

  <script>
    // ===== Estado =====
    let rawText = "";
    let rows = [];
    let data = [];
    let grouped = {};

    // ===== Utils =====
    const $ = (sel) => document.querySelector(sel);
    const el = (tag, cls) => { const x = document.createElement(tag); if (cls) x.className = cls; return x; };
    const numberize = (v) => { if (v==null) return 0; const s=String(v).replace(/\./g,'').replace(/,/g,'.').replace(/[^0-9.-]/g,'').trim(); const n=s===''?0:Number(s); return Number.isFinite(n)?n:0; };
    const cleanText = (s) => String(s ?? "").replace(/\s+/g, " ").trim();
    const escapeHTML = (s) => String(s).replace(/[&<>"']/g, (c) => ({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[c]));

    function looksMisencoded(str){ const bad=(str.match(/√É|ÔøΩ/g)||[]).length; return bad>Math.max(3,str.length*0.01); }

    async function readTextSmart(text, response) {
      rawText = text;
      if(looksMisencoded(rawText)){
        try {
          const buf = await response.arrayBuffer();
          rawText = new TextDecoder('iso-8859-1').decode(new Uint8Array(buf));
          $('#parseWarn').textContent='‚ö†Ô∏è Acentua√ß√£o ISO-8859-1 detectada e corrigida.';
          $('#parseWarn').classList.remove('hidden');
        } catch(e) {
          $('#parseWarn').textContent='‚ö†Ô∏è Poss√≠vel problema de acentua√ß√£o. Salve o CSV em UTF-8.';
          $('#parseWarn').classList.remove('hidden');
        }
      } else {
        $('#parseWarn').classList.add('hidden');
      }
    }

    // ===== Parser com PapaParse (robusto) =====
    function parseWithPapa(text){
      const result = Papa.parse(text, {
        delimiter: '',            // autodetect
        skipEmptyLines: 'greedy', // remove linhas vazias
        dynamicTyping: false
      });
      return result.data.filter(r=> Array.isArray(r) && r.some(c=> String(c).trim()!=='') );
    }

    function detectHeader(r){ if(!r.length) return false; const first=r[0].map(x=>String(x||'').toLowerCase()); const keys=['tipo','categoria','ocorr','ocorr√™ncia','ocorrencias','ocorrencias','maiores','menores']; return keys.some(k=> first.some(c=>c.includes(k))); }

    function normalizeData(r){ const hasHeader=detectHeader(r); if(hasHeader) r=r.slice(1); data = r.map(cols=>{ const c=[...cols]; while(c.length<5) c.push(''); const [tipo,categoria,ocorr,mai,men]=c.slice(0,5); return { tipo:cleanText(tipo), categoria:cleanText(categoria), ocorrencias:numberize(ocorr), detidosMaiores:numberize(mai), menores:numberize(men)}; }).filter(x=>x.tipo && x.categoria); }

    function aggregate(){ grouped={}; for(const row of data){ const cat=row.categoria; if(!grouped[cat]) grouped[cat]={tipos:{}, quantidadeTipos:0, totalOcorrencias:0, totalDetidosMaiores:0, totalMenores:0}; const g=grouped[cat]; if(!g.tipos[row.tipo]){ g.tipos[row.tipo]={ocorrencias:0,detidosMaiores:0,menores:0}; g.quantidadeTipos++; } g.tipos[row.tipo].ocorrencias+=row.ocorrencias; g.tipos[row.tipo].detidosMaiores+=row.detidosMaiores; g.tipos[row.tipo].menores+=row.menores; g.totalOcorrencias+=row.ocorrencias; g.totalDetidosMaiores+=row.detidosMaiores; g.totalMenores+=row.menores; } }

    // ===== Render =====
    function renderSummary(){ const cats=Object.keys(grouped); const totals=cats.reduce((a,k)=>{const g=grouped[k]; a.oc+=g.totalOcorrencias; a.ma+=g.totalDetidosMaiores; a.me+=g.totalMenores; return a;},{oc:0,ma:0,me:0}); const wrap=$('#cards'); wrap.innerHTML=''; wrap.append(createCard(cats.length,'Categorias'), createCard(totals.oc,'Total Ocorr√™ncias'), createCard(totals.ma,'Detidos Maiores'), createCard(totals.me,'Menores')); $('#totals').innerHTML=''; const f=$('#totals'); f.append(makePill('Ocorr√™ncias',totals.oc), makePill('Maiores',totals.ma), makePill('Menores',totals.me)); $('#metaInfo').textContent = `${data.length} linhas | ${cats.length} categorias`; wrap.classList.remove('hidden'); $('#tools').classList.remove('hidden'); $('#cats').classList.remove('hidden'); $('#totals').classList.remove('hidden'); }

    function createCard(val,label){ const c=el('div','card'); const h=el('h3'); h.textContent=val; c.appendChild(h); const p=el('p'); p.textContent=label; c.appendChild(p); return c; }
    function makePill(label,val){ const d=el('div','pill'); d.innerHTML=`${escapeHTML(label)}<br><b>${val}</b>`; return d; }

    function renderCategories(filter=""){ const list=$('#catList'); list.innerHTML=''; const q=(filter||'').toLowerCase().trim(); const entries = Object.entries(grouped)
      .filter(([cat,g])=>{ if(!q) return true; const matchCat = cat.toLowerCase().includes(q); const matchTipo = Object.keys(g.tipos).some(t=> t.toLowerCase().includes(q)); return matchCat || matchTipo; })
      .sort(([,a],[,b])=> b.totalOcorrencias - a.totalOcorrencias);

    for(const [cat,g] of entries){ const row=el('div','row'); row.role='button'; const left=el('div'); const name=el('div','name'); name.textContent=cat; left.appendChild(name); const sub=el('div','muted'); sub.textContent=`${g.quantidadeTipos} tipos`; left.appendChild(sub); const stats=el('div','stats'); stats.append(makePill('Ocorr√™ncias',g.totalOcorrencias), makePill('Maiores',g.totalDetidosMaiores), makePill('Menores',g.totalMenores)); row.append(left,stats); row.addEventListener('click',()=>showTypes(cat)); list.appendChild(row);} 

    if(q && entries.length){ const totals = entries.reduce((acc,[,g])=>{ acc.oc+=g.totalOcorrencias; acc.ma+=g.totalDetidosMaiores; acc.me+=g.totalMenores; return acc; },{oc:0,ma:0,me:0}); const t=el('div','row'); const left=el('div'); const name=el('div','name'); name.textContent='üìä TOTAL FILTRADO'; left.appendChild(name); const sub=el('div','muted'); sub.textContent='Resumo das categorias filtradas'; left.appendChild(sub); const stats=el('div','stats'); stats.append(makePill('Ocorr√™ncias',totals.oc), makePill('Maiores',totals.ma), makePill('Menores',totals.me)); t.append(left,stats); list.appendChild(t);} }

    function showTypes(cat){ const g=grouped[cat]; if(!g) return; $('#types').classList.remove('hidden'); $('#cats').classList.add('hidden'); $('#catTitle').textContent=`Tipos da Categoria: ${cat}`; const list=$('#typeList'); list.innerHTML=''; const entries=Object.entries(g.tipos).sort(([,a],[,b])=> b.ocorrencias - a.ocorrencias); for(const [tipo,d] of entries){ const row=el('div','row'); const left=el('div'); const name=el('div','name'); name.textContent=tipo; left.appendChild(name); const stats=el('div','stats'); stats.append(makePill('Ocorr√™ncias',d.ocorrencias), makePill('Maiores',d.detidosMaiores), makePill('Menores',d.menores)); row.append(left,stats); list.appendChild(row);} const t=el('div','row'); const left=el('div'); const name=el('div','name'); name.textContent='üìä TOTAL DA CATEGORIA'; left.appendChild(name); const stats=el('div','stats'); stats.append(makePill('Ocorr√™ncias',g.totalOcorrencias), makePill('Maiores',g.totalDetidosMaiores), makePill('Menores',g.totalMenores)); t.append(left,stats); list.appendChild(t); }

    function backToCategories(){ $('#types').classList.add('hidden'); $('#cats').classList.remove('hidden'); }

    // ===== Fetch CSV from Google Sheets =====
    async function fetchCSV() {
      $('#loading').classList.remove('hidden');
      $('#parseWarn').classList.add('hidden');
      try {
        const sheetId = '1JB-orpGTvhL1iEGCgTtXpLl4awO7A0zcpFSMZSRE5xU';
        const csvUrl = `https://corsproxy.io/?${encodeURIComponent(`https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv`)}`;
        const response = await fetch(csvUrl);
        if (!response.ok) throw new Error('Falha ao obter o CSV do Google Sheets.');
        const text = await response.text();
        await readTextSmart(text, response);
        rows = parseWithPapa(rawText);
        normalizeData(rows);
        if (!data.length) {
          alert('N√£o foram encontrados dados v√°lidos no CSV. Verifique o formato (5 colunas) e se a planilha est√° p√∫blica.');
          return;
        }
        aggregate();
        renderSummary();
        renderCategories('');
        $('#drop').classList.add('hidden');
      } catch (err) {
        console.error(err);
        $('#parseWarn').textContent = '‚ö†Ô∏è Erro ao carregar o CSV do Google Sheets. Verifique se a planilha est√° p√∫blica ou tente novamente.';
        $('#parseWarn').classList.remove('hidden');
      } finally {
        $('#loading').classList.add('hidden');
      }
    }

    // ===== Eventos =====
    $('#back').addEventListener('click', backToCategories);
    $('#q').addEventListener('input', e => renderCategories(e.target.value));

    // Carrega o CSV automaticamente ao iniciar
    window.addEventListener('load', fetchCSV);

    // ===== Menu Interativo =====
    const menuLinks = document.querySelectorAll('.menu-link');
    const sections = {
      inicial: ['#tools', '#cards', '#cats', '#types', '#totals'],
      drogas: ['#drogas-section'],
      regioes: ['#regioes-section'],
      horarios: ['#horarios-section'],
      equipes: ['#equipes-section']
    };

    function showSection(sectionId) {
      // Esconde todas as se√ß√µes
      Object.values(sections).flat().forEach(sel => {
        const elem = $(sel);
        if (elem) elem.classList.add('hidden');
      });
      // Mostra a se√ß√£o selecionada
      sections[sectionId].forEach(sel => {
        const elem = $(sel);
        if (elem) elem.classList.remove('hidden');
      });
      // Atualiza classe active no menu
      menuLinks.forEach(link => link.classList.remove('active'));
      document.querySelector(`[data-section="${sectionId}"]`).classList.add('active');
    }

    menuLinks.forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const sectionId = link.dataset.section;
        showSection(sectionId);
      });
    });

    // Toggle menu
    const menuToggle = $('#menuToggle');
    const sidebar = $('.sidebar');
    menuToggle.addEventListener('click', () => {
      sidebar.classList.toggle('expanded');
      if (window.innerWidth <= 768) {
        sidebar.classList.toggle('open');
      }
    });

    // Inicialmente mostra a se√ß√£o inicial
    showSection('inicial');
  </script>
</body>
</html>
